stage('Update Manifest File in Mega-Project-CD') {
    steps {
        script {
            // Clean workspace before starting
            cleanWs()

            withCredentials([usernamePassword(credentialsId: 'git', usernameVariable: 'GIT_USERNAME', passwordVariable: 'GIT_PASSWORD')]) {
                sh '''
                # Clone the Mega-Project-CD repository
                git clone https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/jaiswaladi246/Mega-Project-CD.git

                # Update the image tag in the manifest.yaml file
                cd Mega-Project-CD
                sed -i "s|adijaiswal/bankapp:.*|adijaiswal/bankapp:${IMAGE_TAG}|" Manifest/manifest.yaml

                # Confirm changes
                echo "Updated manifest file contents:"
                cat Manifest/manifest.yaml

                # Commit and push the changes
                git config user.name "Jenkins"
                git config user.email "jenkins@example.com"
                git add Manifest/manifest.yaml
                git commit -m "Update image tag to ${IMAGE_TAG}"
                git push origin main
                '''
            }
        }
    }
}
